#!/bin/sh /etc/rc.common
USE_PROCD=1
START=99

start_service() {
    config_load "i2c-ssd1306"

    local enabled
    config_get_bool enabled config enabled 0
    [ "$enabled" -eq 1 ] || return 0

    local i2c_bus i2c_address log_file
    config_get i2c_bus config i2c_bus
    config_get i2c_address config i2c_address
    config_get log_file config log_file

    procd_open_instance
    procd_set_param command /usr/sbin/i2c-ssd1306
    procd_append_param command -i "$i2c_bus"
    procd_append_param command -a "$i2c_address"
    procd_append_param command -l "$log_file"
    procd_set_param respawn
    procd_set_param pidfile /var/run/i2c-ssd1306.pid
    procd_close_instance
    
	if [ ! -f "$(uci get i2c-ssd1306.@i2c-ssd1306[0].log_file)" -o ! -s "$(uci get i2c-ssd1306.@i2c-ssd1306[0].log_file)" ]; then
		echo "  \$(date +%m-%d\ %H:%M:%S)" > /var/log/ssd1306.log
		echo "  HELLO, OPENWRT!" >> /var/log/ssd1306.log
		echo "  LAN:\$(ifstatus lan | jsonfilter -e '@[\"ipv4-address\"][0].address')" >> /var/log/ssd1306.log
		echo "  WAN:\$(ifstatus wan | jsonfilter -e '@[\"ipv4-address\"][0].address')" >> /var/log/ssd1306.log
	fi
}

stop_service() {
    if [ -f /var/run/i2c-ssd1306.pid ]; then
        pid=$(head -n1 /var/run/i2c-ssd1306.pid 2>/dev/null)
        if [ -n "$pid" ] && [ -d "/proc/$pid" ]; then
            echo "running"
            return 0
        fi
    fi
    echo "stopped"
    return 1
}

status_service() {
    [ -f /var/run/i2c-ssd1306.pid ] && echo "running" && return 0
}

service_triggers() {
    procd_add_reload_trigger "i2c-ssd1306"
}
